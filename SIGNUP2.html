<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Profile – Palette and Fit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <style>
:root {
  --bg-light: #f6f3fc;
  --accent: #ad00e2;
  --accent-glow: #e8d8fd;
  --card-bg: #fff;
  --text: #20144a;
  --input-border: #d4c4ef;
  --input-bg: #faf6fe;
  --shadow: 0 8px 36px #ad00e222, 0 1.5px 8px #ad00e208;
  --shadow-dark: 0 6px 32px #0003, 0 1.5px 8px #0002;
  --btn-purple: #ad00e2;
  --btn-purple-dark: #7a2df6;
}
body.dark-mode {
  background: linear-gradient(120deg, #191325 45%, #3a2262 100%);
  color: #fff;
  --input-bg: #201830;
  --card-bg: #2a203d;
  --text: #e7d6fa;
  --input-border: #8852c9;
  --accent: #ad00e2;
  --btn-purple: #ad00e2;
  --btn-purple-dark: #7a2df6;
}
body {
  background: linear-gradient(125deg, #ece9fc 10%, #d3c5ee 95%);
  color: var(--text);
  min-height: 100vh;
  margin: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s, color 0.3s;
  /* font-family: 'Poppins', sans-serif; */
}
.container {
  background: var(--card-bg);
  border-radius: 2.2rem;
  box-shadow: var(--shadow);
  padding: 1rem 2.7rem 1rem 2.7rem;
  max-width: 600px;
  width: 98vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
  min-height: 505px;
  backdrop-filter: blur(2.5px);
  transition: background 0.3s, box-shadow 0.3s;
}
body.dark-mode .container {
  background: #231e2f;
  box-shadow: var(--shadow-dark);
}
/* Navbar/Stepper/Toggle Styles */
.dark-toggle {
  position: absolute;
  top: 1.1rem;
  right: 2.2rem;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 1.2rem;
  font-size: 1.01rem;
  font-weight: 700;
  padding: 0.46rem 1.15rem 0.46rem 1.1rem;
  cursor: pointer;
  box-shadow: 0 2px 12px #ad00e225;
  transition: background 0.18s, color 0.18s;
  z-index: 9;
  outline: none;
  display: block;
}
body.dark-mode .dark-toggle {
  background: #fff;
  color: var(--accent);
}
.dark-toggle-mobile {
  display: none;
  margin-bottom: 1rem;
  width: 100%;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 1.2rem;
  font-size: 1rem;
  font-weight: 700;
  padding: 0.45rem 1.15rem;
  box-shadow: 0 2px 12px #ad00e225;
  transition: background 0.18s, color 0.18s;
}
body.dark-mode .dark-toggle-mobile {
  background: #fff;
  color: var(--accent);
}
.progress-bar {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  margin-bottom: 0.7rem;
  gap: 2.2rem;
  width: 100%;
  margin-top: 0.2rem;
}
.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 1.04rem;
  font-weight: 600;
  color: #b3a5c7;
  gap: 0.2rem;
  transition: color 0.18s;
}
.step.active {
  color: var(--accent);
  font-weight: 900;
}
.step-circle {
  width: 36px; height: 36px;
  border-radius: 50%;
  background: #f5eaff;
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1.2rem;
  margin-bottom: 0.15rem;
  border: 2.5px solid #e8d8fd;
  box-shadow: 0 2px 10px #ad00e21c;
  transition: background 0.2s, color 0.2s, border 0.2s;
}
.step.active .step-circle {
  background: var(--accent);
  color: #fff;
  border: 2.5px solid var(--accent);
  box-shadow: 0 4px 16px #ad00e246;
}
body.dark-mode .step-circle {
  background: #3b1853;
  color: var(--accent);
  border: 2.5px solid var(--accent);
}
body.dark-mode .step.active .step-circle {
  background: var(--accent);
  color: #fff;
  border: 2.5px solid #fff;
}
h2 {
  margin-bottom: 1rem;
  margin-top: 0.3rem;
  color: var(--accent);
  text-align: center;
  font-weight: 800;
  font-size: 2.18rem;
  letter-spacing: 0.3px;
  text-shadow: 0 1px 8px #e8d8fd;
}
body.dark-mode h2 { color: #fff; text-shadow: 0 1px 12px #7a2df6; }
form {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 0.7rem;
  margin-top: 0.0rem;
}
label {
  font-size: 1.01rem;
  font-weight: 600;
  margin-bottom: 0.07rem;
  color: #7054ad;
  margin-left: 2px;
}
body.dark-mode label { color: #cbbcf3; }
input, select {
  width: 100%;
  padding: 0.48rem 1.1rem;
  border-radius: 1rem;
  border: 1.5px solid var(--input-border);
  background: var(--input-bg);
  font-size: 1.06rem;
  color: var(--text);
  outline: none;
  margin-top: 0.07rem;
  transition: border-color 0.18s, box-shadow 0.19s;
  box-shadow: 0 0.5px 3px #b292d11c;
  height: 2.3rem;
  font-weight: 600;
}
body.dark-mode input, body.dark-mode select { color: #fff; background: #291b39; border-color: #845acb; }
.skin-tone-row {
  display: flex; align-items: center; gap: 1.2rem; margin-bottom: 0.4rem; margin-top: 0.2rem;
  flex-wrap: wrap;
}
.skin-preview {
  width: 34px; height: 34px; border-radius: 50%;
  border: 2px solid var(--accent);
  box-shadow: 0 2px 8px #ebd8ff;
  background: #fff;
  transition: background 0.2s;
  display: inline-block;
}
input[type="range"].skin-slider {
  -webkit-appearance: none;
  width: 150px; height: 7px;
  border-radius: 5px;
  background: linear-gradient(90deg, #fff 0%, #ffe3d7 10%, #ffe8c4 25%, #eac086 38%, #ba9775 54%, #d1a67d 66%, #805630 80%, #3c2415 100%);
  outline: none;
  margin: 0 5px;
  transition: background 0.3s;
}
input[type="range"].skin-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 1px 4px #bba8f8;
  border: 2px solid #fff;
  cursor: pointer;
  transition: background 0.18s;
}
.btn,
.camera-btn,
#useSkinToneBtn {
  background: var(--btn-purple);
  color: #fff;
  font-weight: 700;
  font-size: 1.11rem;
  border: none;
  border-radius: 1rem;
  cursor: pointer;
  transition: background 0.19s, box-shadow 0.18s, transform 0.13s, color 0.18s;
  box-shadow: 0 2.2px 14px #ad00e222;
}
.btn {
  margin-top: 0.17rem;
  padding: 0.71rem 0;
  width: 100%;
  letter-spacing: 0.12px;
}
.btn:hover,
.camera-btn:hover,
#useSkinToneBtn:hover {
  background: var(--btn-purple-dark);
  color: #fff;
  transform: translateY(-1px) scale(1.01);
}
.camera-btn {
  border-radius: 0.7rem;
  padding: 0.35rem 0.9rem;
  font-size: 0.99rem;
  margin-left: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
#useSkinToneBtn {
  padding: 0.85rem 2rem;
  font-size: 1.08rem;
  margin-top: 17px;
  width: auto;
  box-shadow: 0 2px 12px #a084f760;
}

/* ----------------- Camera Modal Layout ----------------- */
#cameraModal {
  display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
  z-index:1111; background:rgba(20,15,27,0.97); justify-content:center; align-items:center;
}
#cameraModal .modal-row {
  display: flex; flex-direction: row; width: 90vw; max-width: 990px; min-height: 65vh;
  background: #fff; border-radius: 2.5rem; box-shadow: 0 8px 32px #0003; overflow: hidden;
}
#cameraModal .camera-col {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: #130d20;
  position: relative;
  min-width: 320px;
  min-height: 420px;
  padding-top: 36px;
}
.camera-box-wrap {
  width: 96%; max-width: 340px; aspect-ratio: 320/380;
  position: relative; display: flex; align-items: center; justify-content: center;
}
#modalVideo, #cameraCanvas, #bigGuideCircle {
  width: 100%; height: 100%;
  position: absolute; left: 0; top: 0;
  object-fit: cover; border-radius: 2rem;
}
#bigGuideCircle {
  border: 6px solid #ad00e2;
  border-radius: 50%;
  z-index: 3; pointer-events: none;
  box-shadow: 0 0 0 8px #ad00e233;
}
.camera-warning-under {
  width: 96%; max-width: 340px; margin: 16px auto 0 auto;
  background: #24123f;
  color: #ffd400;
  border-radius: 1.1rem;
  box-shadow: 0 2px 18px #20144a27;
  font-size: 1.05rem;
  font-weight: 600;
  padding: 13px 18px 10px 18px;
  z-index: 10;
  border: 1.2px solid #ffd40038;
  text-align: center;
  letter-spacing: 0.01em;
  transition: background 0.19s;
}
#sampleSkinToneBtn {
  background: linear-gradient(90deg, #ad00e2 80%, #bd7ffe 100%);
  color: #fff;
  font-weight: 700;
  font-size: 1.1rem;
  letter-spacing: 0.04em;
  border: none;
  border-radius: 1.2rem;
  padding: 1rem 2.2rem;
  box-shadow: 0 2px 16px #ad00e236;
  cursor: pointer;
  margin: 18px 0 10px 0;
  transition: background 0.23s;
}
#sampleSkinToneBtn:hover {
  background: linear-gradient(90deg, #bd7ffe 10%, #ad00e2 90%);
}
#closeCameraBtn {
  position:absolute;right:2vw;top:2vh;font-size:2.2rem;background:none;border:none;color:#fff;cursor:pointer;z-index:20;
}
/* --------- Result Side Styles ---------- */
#cameraModal .result-col {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem 1.2rem 2.5rem 2.5rem; min-width: 290px;
  background: linear-gradient(120deg, #f6f3fc 65%, #f2edff 100%);
}
#cameraModal .detected-msg {
  color: #20144a; font-size: 1.18rem; font-weight: 700; margin-bottom: 0.7rem; margin-top: 1.2rem;
}
#cameraModal .tone-preview-big {
  margin: 1.1rem 0 0.6rem 0; width: 60px; height: 60px; border-radius: 50%;
  border: 4px solid #ad00e2;
  box-shadow: 0 4px 18px #ad00e233;
  display: inline-block;
}
#cameraModal .tone-name {
  font-size: 1.13rem; font-weight: 700; color: #ad00e2; margin-bottom: 1.5rem;
}
#cameraModal .use-tone-btn {
  padding: 0.85rem 2.3rem;
  font-size: 1.1rem;
  border-radius: 1.1rem;
  background: #ad00e2;
  color: #fff;
  border: none;
  font-weight: 700;
  box-shadow: 0 2px 12px #a084f760;
  cursor: pointer;
  margin-top: 0.7rem;
}

#cameraModal .use-tone-btn:disabled {
  background: #d1a67d; color: #fff; cursor: not-allowed; opacity: 0.8;
}

/* ---------- Responsive ---------- */
@media (max-width: 800px) {
  #cameraModal .modal-row { flex-direction: column; min-height: 60vh; }
  #cameraModal .camera-col, #cameraModal .result-col { min-width: unset; width: 100%; min-height: 220px; padding: 1.1rem 1rem; }
  #cameraModal .camera-col { min-height: 280px; }
  .camera-box-wrap, .camera-warning-under { max-width: 96vw; }
}
@media (max-width: 700px) {
  .container { padding: 0.4rem 0.4rem 0.4rem 0.4rem; max-width: 99vw; border-radius: 1.2rem;}
  .progress-bar { gap: 1rem; }
  h2 { font-size: 1.21rem; }
  .step-circle { width: 24px; height: 24px; font-size: 0.92rem;}
  .dark-toggle { display: none !important;}
  .dark-toggle-mobile { display: block !important;}
  label, .step { font-size: 0.92rem; }
  input, select { font-size: 0.95rem; height: 1.7rem; }
  .btn, .camera-btn { font-size: 1rem; padding: 0.62rem 0;}
  .skin-preview { width: 28px; height: 28px; }
  .skin-tone-row { gap: 0.7rem;}
}
@media (max-width: 400px) {
  .container { padding: 0.5rem 0.15rem; }
  h2 { font-size: 1.05rem;}
  .step, label { font-size: 0.85rem;}
  .step-circle { width: 18px; height: 18px; font-size: 0.83rem;}
  .btn, .camera-btn { font-size: 0.93rem;}
}

/* Put this in your CSS */
.tone-name-fixed{
  display:inline-block;
  width:140px;          /* reserve space so layout stable */
  min-width:140px;
  margin-left:12px;
  font-weight:600;
  color:#ad00e2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
@media (max-width:700px){
  .tone-name-fixed{ width:110px; min-width:110px; }
}

  </style>

</head>
<body>
  <div class="container">
    <button class="dark-toggle" id="toggleDark">🌙 Dark Mode</button>
    <div style="width:100%">
      <button class="dark-toggle-mobile" id="toggleDarkMobile" style="display:none">🌙 Dark Mode</button>
    </div>
    <div class="progress-bar">
      <div class="step"><div class="step-circle">1</div>Account</div>
      <div class="step active"><div class="step-circle">2</div>Profile</div>
      <div class="step"><div class="step-circle">3</div>Welcome</div>
    </div>
    <h2>Your Profile</h2>
   <form id="profileForm" autocomplete="off">

      <div>
        <label for="name">Full Name</label>
        <input type="text" id="name" maxlength="36" placeholder="Full name" required>
      </div>
      <div>
        <label for="gender">Gender</label>
        <select id="gender" required>
          <option value="" disabled selected>Select Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div>
        <label>Skin Tone <span style="font-size:0.99rem;font-weight:400;color:#888;">(or use Detect with Camera)</span></label>
        <div class="skin-tone-row">
          <span class="skin-preview" id="skinPreview"></span>
          <input type="range" min="0" max="100" value="30" class="skin-slider" id="skinSlider" required>
          <button type="button" class="camera-btn" id="openCameraBtn">
            <svg width="18" height="18" style="vertical-align:-3px;margin-right:3px" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="5" width="14" height="10" rx="2.5" stroke="#fff" stroke-width="2" fill="none"/>
              <circle cx="9" cy="10" r="2.5" stroke="#fff" stroke-width="2" fill="none"/>
              <rect x="7" y="3" width="4" height="2" rx="1" fill="#fff"/>
            </svg>
            Detect with Camera
          </button>
        </div>
        <input type="hidden" id="skinToneColor" required>
      </div>
      <div>
        <label for="age">Age</label>
        <input type="number" min="10" max="100" id="age" placeholder="Enter your age" required>
      </div>
      <button class="btn" type="submit">Continue</button>
    </form>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal">
    <button id="closeCameraBtn">✖</button>
    <div class="modal-row">
      <!-- Left: Camera -->
      <div class="camera-col">
        <div class="camera-box-wrap">
          <video id="modalVideo" autoplay playsinline></video>
          <canvas id="cameraCanvas" width="320" height="380"></canvas>
          <div id="bigGuideCircle"></div>
        </div>
        <div class="camera-warning-under" id="cameraWarning">
          ⚠️ For best results, use in natural daylight.<br>
          Avoid colored light and heavy shadows.
        </div>
        <button id="sampleSkinToneBtn">Sample Skin Tone</button>
      </div>
      <!-- Right: Results -->
      <div class="result-col">
        <h2 style="color:#a380ff;font-weight:800;font-size:2.1rem;letter-spacing:0.5px;">Skin Tone Detection</h2>
        <div class="detected-msg" id="detectedMsg" style="display:none;font-weight:700;font-size:1.18rem;">Yeah, I detected your skin! 🎉</div>
        <div class="tone-preview-big" id="tonePreviewBig" style="display:none;"></div>
        <div class="tone-name" id="toneName" style="display:none;"></div>
        <button class="use-tone-btn" id="useSkinToneBtn" style="display:none;">Use This Skin Tone</button>
     <button class="use-tone-btn" id="tryAgainBtn" style="display:none;margin-left:10px;">Try Again</button>

    </div>
  </div>
<div id="profileMsg" style="text-align:center;color:#ad00e2;font-weight:600"></div>


<script>
// =============== Dark Mode ===============
const darkBtn = document.getElementById('toggleDark');
const darkBtnMobile = document.getElementById('toggleDarkMobile');
const bodyEl = document.body;

function updateDarkText() {
  const isDark = bodyEl.classList.contains('dark-mode');
  if (darkBtn) darkBtn.textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
  if (darkBtnMobile) darkBtnMobile.textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
}
function toggleDarkMode() {
  const nowDark = bodyEl.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', nowDark);
  updateDarkText();
}
if (localStorage.getItem('darkMode') === 'true') bodyEl.classList.add('dark-mode');
updateDarkText();
darkBtn?.addEventListener('click', toggleDarkMode);
darkBtnMobile?.addEventListener('click', toggleDarkMode);

// =============== 24 SKIN TONES ===============
const SKIN_TONES = [
  { name: "Porcelain", hex: "#fff0dc" },{ name: "Ivory", hex: "#ffe7c7" },
  { name: "Fair", hex: "#fde1c8" },{ name: "Light Beige", hex: "#ffe2b0" },
  { name: "Rosy Beige", hex: "#ffe3dd" },{ name: "Vanilla", hex: "#f8e4c2" },
  { name: "Peach", hex: "#ffe0b3" },{ name: "Almond", hex: "#f7d9c4" },
  { name: "Light", hex: "#fbd2a7" },{ name: "Sand", hex: "#fae0bb" },
  { name: "Honey", hex: "#f1c27d" },{ name: "Wheatish", hex: "#eac086" },
  { name: "Golden", hex: "#e6a86c" },{ name: "Olive", hex: "#c49e7b" },
  { name: "Warm Beige", hex: "#f5c185" },{ name: "Tan", hex: "#b98c6b" },
  { name: "Caramel", hex: "#de9e53" },{ name: "Medium Brown", hex: "#a97856" },
  { name: "Chestnut", hex: "#ad7d4c" },{ name: "Dusky", hex: "#704214" },
  { name: "Copper", hex: "#b47838" },{ name: "Deep", hex: "#8d5524" },
  { name: "Rich", hex: "#6d4217" },{ name: "Mocha", hex: "#56351e" }
];
const slider     = document.getElementById('skinSlider');
const preview    = document.getElementById('skinPreview');
const colorInput = document.getElementById('skinToneColor');

function getSkinColor(val){
  const idx = Math.round(val * (SKIN_TONES.length-1) / 100);
  return SKIN_TONES[Math.max(0, Math.min(idx, SKIN_TONES.length-1))].hex;
}
function getToneName(val){
  const idx = Math.round(val * (SKIN_TONES.length-1) / 100);
  return SKIN_TONES[Math.max(0, Math.min(idx, SKIN_TONES.length-1))].name;
}
function getIndexByToneName(name){
  const ix = SKIN_TONES.findIndex(t => t.name.toLowerCase() === String(name||'').toLowerCase());
  return ix >= 0 ? ix : SKIN_TONES.findIndex(t => t.name === "Wheatish");
}

// fixed-width live label (no jitter)
(function toneLabelCSS(){
  if (document.getElementById('tone-label-css')) return;
  const st = document.createElement('style');
  st.id = 'tone-label-css';
  st.textContent = `
    .tone-name-fixed{display:inline-block;width:140px;min-width:140px;margin-left:12px;
      font-weight:600;color:#ad00e2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    @media (max-width:700px){.tone-name-fixed{width:110px;min-width:110px}}
  `;
  document.head.appendChild(st);
})();

function setSliderGradient(){
  if (!slider) return;
  const stops = SKIN_TONES.map((t,i)=>{
    const pct = Math.round((i*100)/(SKIN_TONES.length-1));
    return `${t.hex} ${pct}%`;
  }).join(', ');
  slider.style.background = `linear-gradient(90deg, ${stops})`;
}
function updateSkinPreview(val){
  const v = typeof val === 'undefined' ? parseInt(slider.value||'0',10) : parseInt(val,10);
  if (preview) preview.style.background = getSkinColor(v);
  if (colorInput) colorInput.value = getToneName(v);
  let lbl = document.getElementById('skinToneLiveName');
  if (!lbl){
    lbl = document.createElement('span');
    lbl.id = 'skinToneLiveName';
    lbl.className = 'tone-name-fixed';
    preview?.after(lbl);
  }
  lbl.textContent = getToneName(v);
}
if (slider){
  setSliderGradient();
  slider.addEventListener('input', e => updateSkinPreview(e.target.value));
  updateSkinPreview();
}

// =============== Prefill (backend + localStorage) ===============
async function prefillForm(){
  const nameEl   = document.getElementById('name');
  const ageEl    = document.getElementById('age');
  const genderEl = document.getElementById('gender');

  const email = localStorage.getItem('signupEmail') || localStorage.getItem('user_email');
  if (!email) return;

  // try backend first
  try{
    const r = await fetch('http://127.0.0.1:5001/api/get_profile', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email })
    });
    if (r.ok){
      const data = await r.json();
      if (nameEl && data.name) nameEl.value = data.name;
      if (ageEl  && data.age)  ageEl.value  = data.age;
      if (genderEl){
        let g = (data.gender || localStorage.getItem('signupGender') || '').toLowerCase();
        if (!g) g = 'other';
        genderEl.value = ['male','female','other'].includes(g) ? g :
                         (g.startsWith('m')?'male':g.startsWith('f')?'female':'other');
      }
      if (slider && data.skin_tone){
        const ix = getIndexByToneName(data.skin_tone);
        slider.value = Math.round(ix*100/(SKIN_TONES.length-1));
        updateSkinPreview(slider.value);
      }
      localStorage.setItem('profileData', JSON.stringify({ ...data, phone: (data.phone || localStorage.getItem('signupPhone') || '') }));
      return;
    }
  }catch{}

  // fallback to localStorage
  const pd = JSON.parse(localStorage.getItem('profileData')||'{}');
  if (nameEl && pd.name) nameEl.value = pd.name;
  if (ageEl  && pd.age)  ageEl.value  = pd.age;
  if (genderEl){
    let g = (pd.gender || localStorage.getItem('signupGender') || '').toLowerCase();
    if (!g) g = 'other';
    genderEl.value = ['male','female','other'].includes(g) ? g :
                     (g.startsWith('m')?'male':g.startsWith('f')?'female':'other');
  }
  if (slider && pd.skin_tone){
    const ix = getIndexByToneName(pd.skin_tone);
    slider.value = Math.round(ix*100/(SKIN_TONES.length-1));
    updateSkinPreview(slider.value);
  }
}
prefillForm();

// =============== Camera Modal (optional) ===============
const openCameraBtn  = document.getElementById('openCameraBtn');
const cameraModal    = document.getElementById('cameraModal');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const modalVideo     = document.getElementById('modalVideo');
const cameraCanvas   = document.getElementById('cameraCanvas');
const sampleBtn      = document.getElementById('sampleSkinToneBtn');
const useSkinBtn     = document.getElementById('useSkinToneBtn');
const detectedMsg    = document.getElementById('detectedMsg');
const tonePreviewBig = document.getElementById('tonePreviewBig');
const toneName       = document.getElementById('toneName');
const tryAgainBtn    = document.getElementById('tryAgainBtn');

let stream = null, sampledSliderValue = null;
function closeModal(){
  if (!cameraModal) return;
  cameraModal.style.display = 'none';
  if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if (modalVideo) modalVideo.srcObject = null;
}
function drawVideoFrame(){
  if (!cameraModal || cameraModal.style.display !== 'flex') return;
  const ctx = cameraCanvas.getContext('2d');
  ctx.drawImage(modalVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
  requestAnimationFrame(drawVideoFrame);
}
openCameraBtn?.addEventListener('click', async ()=>{
  if (!cameraModal) return;
  cameraModal.style.display = 'flex';
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:true });
    modalVideo.srcObject = stream;
    await modalVideo.play();
  } catch {
    alert('Camera permission required');
    closeModal();
    return;
  }
  [detectedMsg, tonePreviewBig, toneName, useSkinBtn, tryAgainBtn].forEach(el => el && (el.style.display='none'));
  sampledSliderValue = null;
  drawVideoFrame();
});
closeCameraBtn?.addEventListener('click', closeModal);
cameraModal?.addEventListener('click', e => { if (e.target === cameraModal) closeModal(); });

sampleBtn?.addEventListener('click', ()=>{
  const ctx = cameraCanvas.getContext('2d');
  const W = cameraCanvas.width, H = cameraCanvas.height;
  const box=50, cx=Math.floor(W/2), cy=Math.floor(H/2);
  const sx=Math.max(0,cx-box/2), sy=Math.max(0,cy-box/2);
  const img=ctx.getImageData(sx,sy,box,box);
  let total=[0,0,0], count=0;
  for (let i=0;i<img.data.length;i+=4){ total[0]+=img.data[i]; total[1]+=img.data[i+1]; total[2]+=img.data[i+2]; count++; }
  if (!count) return;
  const avg=total.map(x=>Math.round(x/count));
  let bestVal=0, bestDiff=Infinity;
  for (let v=0; v<=100; v++){
    const c=getSkinColor(v);
    const rgb=[parseInt(c.slice(1,3),16),parseInt(c.slice(3,5),16),parseInt(c.slice(5,7),16)];
    const diff=Math.hypot(rgb[0]-avg[0], rgb[1]-avg[1], rgb[2]-avg[2]);
    if (diff<bestDiff){ bestDiff=diff; bestVal=v; }
  }
  sampledSliderValue=bestVal;
  detectedMsg && (detectedMsg.style.display='');
  if (tonePreviewBig){ tonePreviewBig.style.display=''; tonePreviewBig.style.background=getSkinColor(bestVal); }
  if (toneName){ toneName.style.display=''; toneName.textContent=`This is your skin tone: ${getToneName(bestVal)}`; }
  useSkinBtn && (useSkinBtn.style.display='');
  tryAgainBtn && (tryAgainBtn.style.display='');
  useSkinBtn && (useSkinBtn.disabled=false);
});
useSkinBtn?.addEventListener('click', ()=>{
  if (typeof sampledSliderValue === 'number' && slider){
    slider.value = sampledSliderValue;
    updateSkinPreview(sampledSliderValue);
  }
  closeModal();
});
tryAgainBtn?.addEventListener('click', ()=>{
  [detectedMsg, tonePreviewBig, toneName, useSkinBtn, tryAgainBtn].forEach(el => el && (el.style.display='none'));
  sampledSliderValue=null;
});

// =============== Submit (SEND phone + normalized gender) ===============
document.getElementById('profileForm').addEventListener('submit', async (e)=>{
  e.preventDefault();

  const nameEl   = document.getElementById('name');
  const ageEl    = document.getElementById('age');
  const genderEl = document.getElementById('gender');
  const msgDiv   = document.getElementById('profileMsg');

  const name  = (nameEl?.value || '').trim();
  const age   = parseInt(ageEl?.value || '0', 10);

  // normalize gender: prefer select; fallback signupGender/localStorage
  let gRaw = (genderEl?.value || localStorage.getItem('signupGender') || '').trim();
  gRaw = gRaw ? gRaw[0].toUpperCase() + gRaw.slice(1).toLowerCase() : 'Other';
  const gender = ['Male','Female','Other'].includes(gRaw) ? gRaw : 'Other';

  const skinTone = colorInput?.value || 'Wheatish';

  // bring email + phone from storage
  const email = localStorage.getItem('signupEmail') || localStorage.getItem('user_email');
  const phone = localStorage.getItem('signupPhone') || (JSON.parse(localStorage.getItem('profileData')||'{}').phone || '');

  if (!email){
    msgDiv && (msgDiv.textContent = 'Signup session expired. Please signup again.');
    window.location = 'SIGNUP1.html';
    return;
  }
  localStorage.setItem('user_email', email);

  msgDiv && (msgDiv.textContent = 'Saving profile info...');

  try{
    const res = await fetch('http://127.0.0.1:5001/api/profile', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, name, age, gender, skin_tone: skinTone, phone }) // <-- phone included
    });
    const data = await res.json();

    if (res.ok){
      // cache for profile page
      const prev = JSON.parse(localStorage.getItem('profileData') || '{}');
      localStorage.setItem('profileData', JSON.stringify({
        ...prev, email, name, age, gender, skin_tone: skinTone, phone
      }));
      localStorage.setItem('signupSkinTone', skinTone);

      msgDiv && (msgDiv.textContent = 'Profile info saved! Redirecting...');
      setTimeout(()=>{ window.location = 'SIGNUP3.html'; }, 900);
    } else {
      msgDiv && (msgDiv.textContent = 'Error: ' + (data.error || 'Profile not saved.'));
    }
  } catch (err){
    msgDiv && (msgDiv.textContent = 'Network error. Please try again.');
  }
});
</script>



</body>
</html>